<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿å°”èŒ¨æµ·é»˜ç—‡è¯­éŸ³æ£€æµ‹ç³»ç»Ÿ</title>
    <style>
        /* ========== æ‰€æœ‰CSSæ ·å¼æ”¾åœ¨è¿™é‡Œ ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        /* ... å…¶ä»–æ‰€æœ‰CSSæ ·å¼ ... */
        
        /* å½•éŸ³å¯è§†åŒ–å™¨æ ·å¼ */
        .recording-visualizer {
            width: 100%;
            height: 100px;
            background: #2c3e50;
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        .visualizer-bars {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 100%;
            padding: 0 10px;
        }
        .visualizer-bar {
            width: 8px;
            background: #3498db;
            border-radius: 4px 4px 0 0;
            transition: height 0.1s ease;
        }
        /* ... æ›´å¤šCSSæ ·å¼ ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  é˜¿å°”èŒ¨æµ·é»˜ç—‡è¯­éŸ³æ£€æµ‹ç³»ç»Ÿ</h1>
            <p>åŸºäºäººå·¥æ™ºèƒ½çš„æ—©æœŸç­›æŸ¥å·¥å…· - æ”¯æŒå®æ—¶è¯­éŸ³åˆ†æ</p>
        </div>

        <div class="content">
            <!-- ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ -->
            <div class="card">
                <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
                <div id="systemStatus">
                    <div class="status">æ£€æŸ¥ç³»ç»Ÿä¸­...</div>
                </div>
                <button class="btn" onclick="checkSystemStatus()">åˆ·æ–°çŠ¶æ€</button>
            </div>

            <!-- å®æ—¶å½•éŸ³æ£€æµ‹ -->
            <div class="card">
                <h2>ğŸ¤ å®æ—¶è¯­éŸ³æ£€æµ‹</h2>
                <div class="instructions">
                    <p><span class="step-number">1</span> ç‚¹å‡»"å¼€å§‹å½•éŸ³"æŒ‰é’®ï¼Œè¯·ç”¨æ¸…æ™°ã€è‡ªç„¶çš„å£°éŸ³æœ—è¯»ä¸€æ®µæ–‡å­—</p>
                    <p><span class="step-number">2</span> å»ºè®®æœ—è¯»æ—¶é—´ï¼š10-30ç§’</p>
                    <p><span class="step-number">3</span> å®Œæˆåç‚¹å‡»"åœæ­¢å½•éŸ³"ï¼Œç„¶åç‚¹å‡»"æ£€æµ‹å½•éŸ³"è¿›è¡Œåˆ†æ</p>
                </div>

                <div class="recording-container">
                    <div id="recordingControls">
                        <button class="btn btn-success" id="startRecording" onclick="startRecording()">
                            ğŸ¤ å¼€å§‹å½•éŸ³
                        </button>
                        <button class="btn btn-danger" id="stopRecording" onclick="stopRecording()" disabled>
                            â¹ï¸ åœæ­¢å½•éŸ³
                        </button>
                        <button class="btn" id="playRecording" onclick="playRecording()" disabled>
                            â–¶ï¸ æ’­æ”¾å½•éŸ³
                        </button>
                        <button class="btn btn-warning" id="analyzeRecording" onclick="analyzeRecording()" disabled>
                            ğŸ” æ£€æµ‹å½•éŸ³
                        </button>
                    </div>

                    <div id="recordingStatus" style="display: none;">
                        <span class="recording-indicator"></span>
                        <span>æ­£åœ¨å½•éŸ³ä¸­...</span>
                    </div>

                    <div class="recording-timer" id="recordingTimer">00:00</div>

                    <div class="recording-visualizer">
                        <div class="visualizer-bars" id="visualizer"></div>
                    </div>

                    <audio id="audioPlayback" class="audio-playback" controls style="display: none;"></audio>

                    <div id="recordingInfo" style="display: none; margin-top: 15px;">
                        <div class="status status-warning">
                            âœ… å½•éŸ³å·²å®Œæˆï¼Œè¯·ç‚¹å‡»"æ£€æµ‹å½•éŸ³"æŒ‰é’®è¿›è¡Œåˆ†æ
                        </div>
                    </div>
                </div>

                <!-- å½•éŸ³å†å²è®°å½• -->
                <div id="recordingsHistory" style="display: none;">
                    <h3>ğŸ“‹ å½•éŸ³å†å²è®°å½•</h3>
                    <div class="recordings-history" id="historyList">
                        <!-- å½•éŸ³å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å¿«é€Ÿæ£€æµ‹ -->
            <div class="card">
                <h2>âš¡ å¿«é€Ÿæ£€æµ‹</h2>
                <p>ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œå¿«é€Ÿæµ‹è¯•</p>
                <button class="btn btn-success" onclick="runDemoTest()">è¿è¡Œæ¼”ç¤ºæµ‹è¯•</button>
                <button class="btn btn-danger" onclick="runADSimulation()">æ¨¡æ‹ŸADæ‚£è€…æ£€æµ‹</button>
                <button class="btn" onclick="runNormalSimulation()">æ¨¡æ‹Ÿæ­£å¸¸äººæ£€æµ‹</button>
            </div>

            <!-- ç»“æœæ˜¾ç¤º -->
            <div class="card">
                <h2>ğŸ“ˆ æ£€æµ‹ç»“æœ</h2>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
                </div>
                <div id="result" class="result"></div>
            </div>
        </div>
    </div>

    <!-- ========== JavaScriptä»£ç æ”¾åœ¨è¿™é‡Œ - åœ¨</body>ä¹‹å‰ ========== -->
    <script>
        // å½•éŸ³ç›¸å…³å˜é‡
        let mediaRecorder;
        let audioChunks = [];
        let recordingTimer;
        let seconds = 0;
        let audioContext;
        let analyser;
        let dataArray;
        let bufferLength;
        let visualizerBars;
        let currentRecordingId = null;
        let currentAudioBlob = null;
        let recordingsHistory = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            checkSystemStatus();
            initializeVisualizer();
            loadRecordingsHistory();
        };

        // åˆå§‹åŒ–éŸ³é¢‘å¯è§†åŒ–å™¨
        function initializeVisualizer() {
            const visualizer = document.getElementById('visualizer');
            if (!visualizer) return;
            
            visualizer.innerHTML = '';
            visualizerBars = [];

            // åˆ›å»º32ä¸ªå¯è§†åŒ–æ¡
            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.height = '5px';
                visualizer.appendChild(bar);
                visualizerBars.push(bar);
            }
        }

        // æ›´æ–°éŸ³é¢‘å¯è§†åŒ–
        function updateVisualizer() {
            if (!analyser) return;

            analyser.getByteFrequencyData(dataArray);

            for (let i = 0; i < bufferLength; i++) {
                const value = dataArray[i];
                const percentage = value / 256;
                const bar = visualizerBars[i];

                if (bar) {
                    bar.style.height = `${Math.max(5, percentage * 100)}px`;
                    // æ ¹æ®éŸ³é‡æ”¹å˜é¢œè‰²
                    const green = Math.min(255, value + 100);
                    bar.style.background = `rgb(${value}, ${green}, 200)`;
                }
            }

            requestAnimationFrame(updateVisualizer);
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                // è¯·æ±‚éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // è®¾ç½®éŸ³é¢‘ä¸Šä¸‹æ–‡å’Œåˆ†æå™¨
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 64;
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                // è®¾ç½®MediaRecorder
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    currentAudioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(currentAudioBlob);

                    // è®¾ç½®éŸ³é¢‘æ’­æ”¾
                    const audioPlayback = document.getElementById('audioPlayback');
                    if (audioPlayback) {
                        audioPlayback.src = audioUrl;
                        audioPlayback.style.display = 'block';
                    }

                    // å¯ç”¨æ’­æ”¾å’Œåˆ†ææŒ‰é’®
                    document.getElementById('playRecording').disabled = false;
                    document.getElementById('analyzeRecording').disabled = false;

                    // æ˜¾ç¤ºå½•éŸ³å®Œæˆä¿¡æ¯
                    const recordingInfo = document.getElementById('recordingInfo');
                    if (recordingInfo) recordingInfo.style.display = 'block';

                    // åœæ­¢å¯è§†åŒ–
                    if (audioContext) {
                        audioContext.close();
                    }

                    // ç”Ÿæˆå”¯ä¸€IDç”¨äºæ ‡è¯†è¿™æ¬¡å½•éŸ³
                    currentRecordingId = 'rec_' + Date.now();

                    // ä¿å­˜å½•éŸ³åˆ°å†å²è®°å½•
                    saveRecordingToHistory(currentRecordingId, currentAudioBlob, seconds);
                };

                // å¼€å§‹å½•éŸ³
                mediaRecorder.start();

                // æ›´æ–°UI
                document.getElementById('startRecording').disabled = true;
                document.getElementById('stopRecording').disabled = false;
                document.getElementById('recordingStatus').style.display = 'block';
                document.getElementById('recordingTimer').textContent = '00:00';
                document.getElementById('recordingInfo').style.display = 'none';
                document.getElementById('analyzeRecording').disabled = true;

                // å¼€å§‹è®¡æ—¶å™¨
                seconds = 0;
                recordingTimer = setInterval(() => {
                    seconds++;
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    document.getElementById('recordingTimer').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;

                    // è‡ªåŠ¨åœæ­¢å½•éŸ³ï¼ˆæœ€å¤š2åˆ†é’Ÿï¼‰
                    if (seconds >= 120) {
                        stopRecording();
                    }
                }, 1000);

                // å¼€å§‹å¯è§†åŒ–
                updateVisualizer();

            } catch (error) {
                alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
                console.error('å½•éŸ³é”™è¯¯:', error);
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();

                // åœæ­¢æ‰€æœ‰éŸ³è½¨
                mediaRecorder.stream.getTracks().forEach(track => track.stop());

                // æ›´æ–°UI
                document.getElementById('startRecording').disabled = false;
                document.getElementById('stopRecording').disabled = true;
                document.getElementById('recordingStatus').style.display = 'none';

                // åœæ­¢è®¡æ—¶å™¨
                clearInterval(recordingTimer);

                // é‡ç½®å¯è§†åŒ–å™¨
                initializeVisualizer();
            }
        }

        // æ’­æ”¾å½•éŸ³
        function playRecording() {
            const audioPlayback = document.getElementById('audioPlayback');
            if (audioPlayback) {
                audioPlayback.play();
            }
        }

        // åˆ†æå½•éŸ³
        function analyzeRecording() {
            if (!currentAudioBlob) {
                alert('æ²¡æœ‰å¯åˆ†æçš„å½•éŸ³æ•°æ®');
                return;
            }

            showLoading();

            // æ¨¡æ‹ŸAPIè°ƒç”¨ - ä½¿ç”¨éšæœºæ•°æ®
            setTimeout(() => {
                hideLoading();
                
                // ç”Ÿæˆæ¨¡æ‹Ÿåˆ†æç»“æœ
                const analysisResult = generateMockAnalysis();
                displayResult(analysisResult);
                
                // æ›´æ–°å½•éŸ³å†å²è®°å½•ä¸­çš„åˆ†æç»“æœ
                if (currentRecordingId) {
                    updateRecordingAnalysis(currentRecordingId, analysisResult);
                }
            }, 2000);
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿåˆ†æç»“æœ
        function generateMockAnalysis() {
            // åŸºäºå½•éŸ³æ—¶é•¿ç”Ÿæˆæ›´"åˆç†"çš„æ¦‚ç‡
            const durationFactor = Math.min(1, seconds / 30); // 30ç§’ä¸ºç†æƒ³æ—¶é•¿
            const baseProb = 0.2 + (Math.random() * 0.6); // 0.2-0.8ä¹‹é—´
            const adjustedProb = baseProb * (0.3 + 0.7 * durationFactor); // è€ƒè™‘æ—¶é•¿å› ç´ 
            
            const probability = Math.min(0.95, Math.max(0.05, adjustedProb));
            
            let riskLevel, recommendation;
            if (probability >= 0.7) {
                riskLevel = "é«˜é£é™©";
                recommendation = "å»ºè®®å°½å¿«å’¨è¯¢ç¥ç»ç§‘åŒ»ç”Ÿè¿›è¡Œä¸“ä¸šè¯„ä¼°å’Œè¿›ä¸€æ­¥æ£€æŸ¥";
            } else if (probability >= 0.4) {
                riskLevel = "ä¸­é£é™©";
                recommendation = "å»ºè®®å®šæœŸè¿›è¡Œè®¤çŸ¥åŠŸèƒ½è¯„ä¼°ï¼Œå…³æ³¨æ—¥å¸¸ç”Ÿæ´»ä¸­çš„å˜åŒ–";
            } else {
                riskLevel = "ä½é£é™©";
                recommendation = "å½“å‰è®¤çŸ¥åŠŸèƒ½çŠ¶å†µè‰¯å¥½ï¼Œå»ºè®®ä¿æŒå¥åº·ç”Ÿæ´»æ–¹å¼";
            }

            return {
                success: true,
                prediction: {
                    ad_probability: probability,
                    predicted_label: probability > 0.5 ? 1 : 0,
                    risk_level: riskLevel,
                    timestamp: new Date().toLocaleString()
                },
                interpretation: {
                    message: `ADç­›æŸ¥é£é™©ç­‰çº§: ${riskLevel}`,
                    confidence: probability,
                    recommendation: recommendation
                },
                audio_duration: seconds,
                recording_id: currentRecordingId
            };
        }

        // ä¿å­˜å½•éŸ³åˆ°å†å²è®°å½•
        function saveRecordingToHistory(id, blob, duration) {
            const recording = {
                id: id,
                blob: blob,
                duration: duration,
                timestamp: new Date().toLocaleString(),
                analyzed: false,
                result: null
            };

            recordingsHistory.unshift(recording); // æ·»åŠ åˆ°å¼€å¤´

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveRecordingsToStorage();

            // æ›´æ–°UI
            updateRecordingsHistoryUI();
        }

        // æ›´æ–°å½•éŸ³çš„åˆ†æç»“æœ
        function updateRecordingAnalysis(id, result) {
            const recording = recordingsHistory.find(r => r.id === id);
            if (recording) {
                recording.analyzed = true;
                recording.result = result;

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveRecordingsToStorage();

                // æ›´æ–°UI
                updateRecordingsHistoryUI();
            }
        }

        // æ›´æ–°å½•éŸ³å†å²è®°å½•çš„UI
        function updateRecordingsHistoryUI() {
            const historyList = document.getElementById('historyList');
            const recordingsHistoryDiv = document.getElementById('recordingsHistory');

            if (!historyList || !recordingsHistoryDiv) return;

            if (recordingsHistory.length === 0) {
                recordingsHistoryDiv.style.display = 'none';
                return;
            }

            recordingsHistoryDiv.style.display = 'block';
            historyList.innerHTML = '';

            recordingsHistory.forEach(recording => {
                const item = document.createElement('div');
                item.className = 'recording-item';

                let resultInfo = '';
                if (recording.analyzed && recording.result) {
                    const riskLevel = recording.result.prediction.risk_level;
                    const probability = (recording.result.prediction.ad_probability * 100).toFixed(1);
                    resultInfo = `<div>åˆ†æç»“æœ: ${riskLevel} (${probability}%)</div>`;
                }

                item.innerHTML = `
                    <div class="recording-info">
                        <div>å½•éŸ³æ—¶é—´: ${recording.timestamp}</div>
                        <div>æ—¶é•¿: ${recording.duration}ç§’</div>
                        ${resultInfo}
                    </div>
                    <div class="recording-actions">
                        <button class="btn small-btn" onclick="playRecordingFromHistory('${recording.id}')">æ’­æ”¾</button>
                        ${!recording.analyzed ? `<button class="btn small-btn btn-warning" onclick="analyzeRecordingFromHistory('${recording.id}')">æ£€æµ‹</button>` : ''}
                        <button class="btn small-btn btn-danger" onclick="deleteRecording('${recording.id}')">åˆ é™¤</button>
                    </div>
                `;

                historyList.appendChild(item);
            });
        }

        // ä»å†å²è®°å½•æ’­æ”¾å½•éŸ³
        function playRecordingFromHistory(id) {
            const recording = recordingsHistory.find(r => r.id === id);
            if (recording && recording.blob) {
                const audioUrl = URL.createObjectURL(recording.blob);
                const audio = new Audio(audioUrl);
                audio.play();
            }
        }

        // ä»å†å²è®°å½•åˆ†æå½•éŸ³
        function analyzeRecordingFromHistory(id) {
            const recording = recordingsHistory.find(r => r.id === id);
            if (recording) {
                showLoading();
                
                // æ¨¡æ‹Ÿåˆ†æè¿‡ç¨‹
                setTimeout(() => {
                    hideLoading();
                    const analysisResult = generateMockAnalysis();
                    
                    // æ›´æ–°å½•éŸ³å†å²è®°å½•ä¸­çš„åˆ†æç»“æœ
                    updateRecordingAnalysis(recording.id, analysisResult);
                    displayResult(analysisResult);
                }, 2000);
            }
        }

        // åˆ é™¤å½•éŸ³
        function deleteRecording(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å½•éŸ³è®°å½•å—ï¼Ÿ')) {
                recordingsHistory = recordingsHistory.filter(r => r.id !== id);
                saveRecordingsToStorage();
                updateRecordingsHistoryUI();
            }
        }

        // ä¿å­˜å½•éŸ³å†å²åˆ°æœ¬åœ°å­˜å‚¨
        function saveRecordingsToStorage() {
            // æ³¨æ„ï¼šBlobå¯¹è±¡ä¸èƒ½ç›´æ¥å­˜å‚¨åˆ°localStorage
            // è¿™é‡Œæˆ‘ä»¬åªå­˜å‚¨å…ƒæ•°æ®ï¼Œå®é™…éŸ³é¢‘æ•°æ®åœ¨å†…å­˜ä¸­
            const recordingsMetadata = recordingsHistory.map(r => ({
                id: r.id,
                duration: r.duration,
                timestamp: r.timestamp,
                analyzed: r.analyzed,
                result: r.result
            }));

            localStorage.setItem('ad_recordings_metadata', JSON.stringify(recordingsMetadata));
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å½•éŸ³å†å²
        function loadRecordingsHistory() {
            const storedMetadata = localStorage.getItem('ad_recordings_metadata');
            if (storedMetadata) {
                const metadata = JSON.parse(storedMetadata);
                // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åªåŠ è½½å…ƒæ•°æ®ï¼Œå®é™…éŸ³é¢‘æ•°æ®ä¸ä¼šæŒä¹…åŒ–
                recordingsHistory = metadata.map(m => ({
                    id: m.id,
                    blob: null, // éŸ³é¢‘æ•°æ®ä¸ä¼šæŒä¹…åŒ–
                    duration: m.duration,
                    timestamp: m.timestamp,
                    analyzed: m.analyzed,
                    result: m.result
                }));

                updateRecordingsHistoryUI();
            }
        }

        // ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ï¼ˆæ¨¡æ‹Ÿï¼‰
        function checkSystemStatus() {
            // æ¨¡æ‹ŸAPIè°ƒç”¨
            setTimeout(() => {
                const statusDiv = document.getElementById('systemStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = '<div class="status status-ok">âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸ - åœ¨çº¿æ¼”ç¤ºç‰ˆæœ¬</div>';
                }
            }, 500);
        }

        // è¿è¡Œæ¼”ç¤ºæµ‹è¯•
        function runDemoTest() {
            showLoading();
            // æ¨¡æ‹ŸAPIè°ƒç”¨
            setTimeout(() => {
                hideLoading();
                const result = generateMockAnalysis();
                displayResult(result);
            }, 1500);
        }

        // æ¨¡æ‹ŸADæ‚£è€…æ£€æµ‹
        function runADSimulation() {
            showLoading();
            // æ¨¡æ‹ŸAPIè°ƒç”¨ï¼Œåå‘é«˜é£é™©
            setTimeout(() => {
                hideLoading();
                const baseProb = 0.6 + Math.random() * 0.3; // 0.6-0.9ä¹‹é—´
                const result = generateMockAnalysisWithProbability(baseProb);
                displayResult(result);
            }, 1500);
        }

        // æ¨¡æ‹Ÿæ­£å¸¸äººæ£€æµ‹
        function runNormalSimulation() {
            showLoading();
            // æ¨¡æ‹ŸAPIè°ƒç”¨ï¼Œåå‘ä½é£é™©
            setTimeout(() => {
                hideLoading();
                const baseProb = Math.random() * 0.3; // 0-0.3ä¹‹é—´
                const result = generateMockAnalysisWithProbability(baseProb);
                displayResult(result);
            }, 1500);
        }

        // ç”ŸæˆæŒ‡å®šæ¦‚ç‡çš„æ¨¡æ‹Ÿåˆ†æ
        function generateMockAnalysisWithProbability(probability) {
            probability = Math.min(0.95, Math.max(0.05, probability));
            
            let riskLevel, recommendation;
            if (probability >= 0.7) {
                riskLevel = "é«˜é£é™©";
                recommendation = "å»ºè®®å°½å¿«å’¨è¯¢ç¥ç»ç§‘åŒ»ç”Ÿè¿›è¡Œä¸“ä¸šè¯„ä¼°å’Œè¿›ä¸€æ­¥æ£€æŸ¥";
            } else if (probability >= 0.4) {
                riskLevel = "ä¸­é£é™©";
                recommendation = "å»ºè®®å®šæœŸè¿›è¡Œè®¤çŸ¥åŠŸèƒ½è¯„ä¼°ï¼Œå…³æ³¨æ—¥å¸¸ç”Ÿæ´»ä¸­çš„å˜åŒ–";
            } else {
                riskLevel = "ä½é£é™©";
                recommendation = "å½“å‰è®¤çŸ¥åŠŸèƒ½çŠ¶å†µè‰¯å¥½ï¼Œå»ºè®®ä¿æŒå¥åº·ç”Ÿæ´»æ–¹å¼";
            }

            return {
                success: true,
                prediction: {
                    ad_probability: probability,
                    predicted_label: probability > 0.5 ? 1 : 0,
                    risk_level: riskLevel,
                    timestamp: new Date().toLocaleString()
                },
                interpretation: {
                    message: `ADç­›æŸ¥é£é™©ç­‰çº§: ${riskLevel}`,
                    confidence: probability,
                    recommendation: recommendation
                }
            };
        }

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function showLoading() {
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            if (loading) loading.style.display = 'block';
            if (result) result.style.display = 'none';
        }

        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'none';
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            if (!resultDiv) return;
            
            resultDiv.style.display = 'block';

            if (data.success) {
                const pred = data.prediction;
                const interpret = data.interpretation;

                // æ ¹æ®é£é™©ç­‰çº§è®¾ç½®æ ·å¼
                let riskClass = 'risk-low';
                if (interpret.message.includes('é«˜é£é™©')) riskClass = 'risk-high';
                else if (interpret.message.includes('ä¸­é£é™©')) riskClass = 'risk-medium';

                resultDiv.className = 'result ' + riskClass;
                resultDiv.innerHTML = `
                    <h3>æ£€æµ‹ç»“æœ</h3>
                    <p><strong>é£é™©ç­‰çº§:</strong> ${pred.risk_level}</p>
                    <p><strong>ADæ¦‚ç‡:</strong> ${(pred.ad_probability * 100).toFixed(1)}%</p>
                    <p><strong>å»ºè®®:</strong> ${interpret.recommendation}</p>
                    <p><strong>æ£€æµ‹æ—¶é—´:</strong> ${pred.timestamp}</p>
                    ${data.audio_duration ? `<p><strong>å½•éŸ³æ—¶é•¿:</strong> ${data.audio_duration}ç§’</p>` : ''}
                    ${data.recording_id ? `<p><strong>å½•éŸ³ID:</strong> ${data.recording_id}</p>` : ''}
                `;
            } else {
                resultDiv.className = 'result risk-high';
                resultDiv.innerHTML = `
                    <h3>æ£€æµ‹å¤±è´¥</h3>
                    <p>é”™è¯¯ä¿¡æ¯: ${data.error}</p>
                `;
            }
        }
    </script>
</body>
</html>
